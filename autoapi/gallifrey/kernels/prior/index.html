
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ChrisBoettner.github.io/gallifrey/autoapi/gallifrey/kernels/prior/">
      
      
        <link rel="prev" href="../library/">
      
      
        <link rel="next" href="../tree/">
      
      
      <link rel="icon" href="../../../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>prior - gallifrey Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gallifrey.kernels.prior" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="gallifrey Documentation" class="md-header__button md-logo" aria-label="gallifrey Documentation" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            gallifrey Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              prior
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="lime"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ChrisBoettner/gallifrey" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="gallifrey Documentation" class="md-nav__button md-logo" aria-label="gallifrey Documentation" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    gallifrey Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ChrisBoettner/gallifrey" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../stellar_variability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Time series interpolation and forecasting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transit fitting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../comparison_with_simple_kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comparison with simple kernel
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transmission_spectrum/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transmission spectrum of HATS-46 b
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    gallifrey
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            gallifrey
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gpconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gpconfig
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_3" >
        
          
          <label class="md-nav__link" for="__nav_4_1_3" id="__nav_4_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    inference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_3">
            <span class="md-nav__icon md-icon"></span>
            inference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/hmc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hmc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/parameter_rejuvenation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    parameter_rejuvenation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/rejuvenation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    rejuvenation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/smc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    smc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../inference/transforms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    transforms
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_1_4" id="__nav_4_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    kernels
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_1_4">
            <span class="md-nav__icon md-icon"></span>
            kernels
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../atoms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    atoms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    prior
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    prior
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior" class="md-nav__link">
    <span class="md-ellipsis">
      prior
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior" class="md-nav__link">
    <span class="md-ellipsis">
      KernelPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KernelPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.reconstruct_kernel" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_kernel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.sample_kernel" class="md-nav__link">
    <span class="md-ellipsis">
      sample_kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior" class="md-nav__link">
    <span class="md-ellipsis">
      ParameterPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParameterPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.log_prob" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.log_prob_subset" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_subset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.sample_subset" class="md-nav__link">
    <span class="md-ellipsis">
      sample_subset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior" class="md-nav__link">
    <span class="md-ellipsis">
      TreeStructurePrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TreeStructurePrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.log_prob" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.log_prob_single" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_single
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.sample_single" class="md-nav__link">
    <span class="md-ellipsis">
      sample_single
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.log_prob_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_parameters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.sample_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      sample_parameters
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tree/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tree
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_6" >
        
          
          <label class="md-nav__link" for="__nav_4_1_6" id="__nav_4_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    moves
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_6">
            <span class="md-nav__icon md-icon"></span>
            moves
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moves/acceptance_probability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    acceptance_probability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moves/detach_attach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    detach_attach
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moves/noise_proposal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    noise_proposal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moves/particle_move/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    particle_move
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moves/subtree_replace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    subtree_replace
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parameter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    parameter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../particles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    particles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    schedule
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_10" >
        
          
          <label class="md-nav__link" for="__nav_4_1_10" id="__nav_4_1_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_10">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/probability_calculations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    probability_calculations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/tree_helper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tree_helper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/typing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    typing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior" class="md-nav__link">
    <span class="md-ellipsis">
      prior
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior" class="md-nav__link">
    <span class="md-ellipsis">
      KernelPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="KernelPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.reconstruct_kernel" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruct_kernel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.KernelPrior.sample_kernel" class="md-nav__link">
    <span class="md-ellipsis">
      sample_kernel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior" class="md-nav__link">
    <span class="md-ellipsis">
      ParameterPrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParameterPrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.log_prob" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.log_prob_subset" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_subset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.ParameterPrior.sample_subset" class="md-nav__link">
    <span class="md-ellipsis">
      sample_subset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior" class="md-nav__link">
    <span class="md-ellipsis">
      TreeStructurePrior
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TreeStructurePrior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.log_prob" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.log_prob_single" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_single
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.sample" class="md-nav__link">
    <span class="md-ellipsis">
      sample
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.TreeStructurePrior.sample_single" class="md-nav__link">
    <span class="md-ellipsis">
      sample_single
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.log_prob_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      log_prob_parameters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gallifrey.kernels.prior.sample_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      sample_parameters
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>prior</h1>

<div class="doc doc-object doc-module">



<a id="gallifrey.kernels.prior"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="gallifrey.kernels.prior.KernelPrior" class="doc doc-heading">
            <code>KernelPrior</code>


</h2>


    <div class="doc doc-contents ">


        <p>A prior distribution over kernel structures and parameters.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.kernel_library">kernel_library</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="KernelLibrary (gallifrey.kernels.library.KernelLibrary)" href="../library/#gallifrey.kernels.library.KernelLibrary">KernelLibrary</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the KernelLibrary class, containing
the kernel classes and operators, and transformation functions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.kernel_structure_prior">kernel_structure_prior</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TreeStructurePrior (gallifrey.kernels.prior.TreeStructurePrior)" href="#gallifrey.kernels.prior.TreeStructurePrior">TreeStructurePrior</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A prior distribution over kernel structures.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.parameter_prior">parameter_prior</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParameterPrior (gallifrey.kernels.prior.ParameterPrior)" href="#gallifrey.kernels.prior.ParameterPrior">ParameterPrior</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A prior distribution over kernel parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.max_depth">max_depth</span></code></td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel structure tree.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.num_datapoints">num_datapoints</span></code></td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of data points in the dataset.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.max_kernel_parameter">max_kernel_parameter</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of kernel parameters (max_atom_parameters
* max_leaves).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.graphdef">graphdef</span></code></td>
            <td>
                  <code><span title="flax.nnx.GraphDef">GraphDef</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph definition of the kernel. Used together with the
kernel state to create a TreeKernel object.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.kernels">kernels</span></code></td>
            <td>
                  <code><span title="beartype.typing.List">List</span>[<span title="beartype.typing.Type">Type</span>[<a class="autorefs autorefs-internal" title="TreeKernel (gallifrey.kernels.tree.TreeKernel)" href="../tree/#gallifrey.kernels.tree.TreeKernel">TreeKernel</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of kernel classes. (inherited from the kernel_library,
see gallifrey.kernels.library.KernelLibrary)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.operators">operators</span></code></td>
            <td>
                  <code><span title="beartype.typing.List">List</span>[<span title="beartype.typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of operators. (inherited from the kernel_library,
see gallifrey.kernels.library.KernelLibrary)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.is_operator">is_operator</span></code></td>
            <td>
                  <code><span title="jaxtyping.Bool">Bool</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that indicates whether each kernel in the library is an operator.
(inherited from the kernel_library, see gallifrey.kernels.library.KernelLibrary)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.probs">probs</span></code></td>
            <td>
                  <code><span title="jaxtyping.Float">Float</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probabilities of sampling each kernel (or operator) in the library.
(inherited from the kernel_structure_prior,
  see gallifrey.kernels.prior.TreeStructurePrior)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.prior_transforms">prior_transforms</span></code></td>
            <td>
                  <code><span title="flax.core.FrozenDict">FrozenDict</span>[<span title="str">str</span>, <span title="tensorflow_probability.substrates.jax.bijectors.Bijector">Bijector</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A (frozen) dictionary containing bijectors for transforming the
distribution of the sampled parameters from a standard
normal to the desired prior distribution. (inherited from the kernel_library,
see gallifrey.kernels.library.KernelLibrary)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.KernelPrior.support_bijectors">support_bijectors</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="tensorflow_probability.substrates.jax.bijectors.Bijector">Bijector</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of bijectors for transforming the parameters from a constrained
support space to an unconstrained space. Primarely used for the
numerically stable optimization and sampling of the parameters (in a
jit-compatible way).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KernelPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A prior distribution over kernel structures and parameters.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_library : KernelLibrary</span>
<span class="sd">        An instance of the KernelLibrary class, containing</span>
<span class="sd">        the kernel classes and operators, and transformation functions.</span>
<span class="sd">    kernel_structure_prior : TreeStructurePrior</span>
<span class="sd">        A prior distribution over kernel structures.</span>
<span class="sd">    parameter_prior : ParameterPrior</span>
<span class="sd">        A prior distribution over kernel parameters.</span>
<span class="sd">    max_depth : ScalarInt</span>
<span class="sd">        The maximum depth of the nested kernel structure tree.</span>
<span class="sd">    num_datapoints : ScalarInt</span>
<span class="sd">        The number of data points in the dataset.</span>
<span class="sd">    max_kernel_parameter : int</span>
<span class="sd">        The maximum number of kernel parameters (max_atom_parameters</span>
<span class="sd">        * max_leaves).</span>

<span class="sd">    graphdef : nnx.GraphDef</span>
<span class="sd">        The graph definition of the kernel. Used together with the</span>
<span class="sd">        kernel state to create a TreeKernel object.</span>

<span class="sd">    kernels : tp.List[tp.Type[TreeKernel]]</span>
<span class="sd">        A list of kernel classes. (inherited from the kernel_library,</span>
<span class="sd">        see gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">    operators : tp.List[tp.Callable]</span>
<span class="sd">        A list of operators. (inherited from the kernel_library,</span>
<span class="sd">        see gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">    is_operator : Bool[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that indicates whether each kernel in the library is an operator.</span>
<span class="sd">        (inherited from the kernel_library, see gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">    probs :  Float[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">        (inherited from the kernel_structure_prior,</span>
<span class="sd">          see gallifrey.kernels.prior.TreeStructurePrior)</span>
<span class="sd">    prior_transforms : FrozenDict[str, tfb.Bijector]</span>
<span class="sd">        A (frozen) dictionary containing bijectors for transforming the</span>
<span class="sd">        distribution of the sampled parameters from a standard</span>
<span class="sd">        normal to the desired prior distribution. (inherited from the kernel_library,</span>
<span class="sd">        see gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">    support_bijectors : tuple[tfb.Bijector, ...]</span>
<span class="sd">        A tuple of bijectors for transforming the parameters from a constrained</span>
<span class="sd">        support space to an unconstrained space. Primarely used for the</span>
<span class="sd">        numerically stable optimization and sampling of the parameters (in a</span>
<span class="sd">        jit-compatible way).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_datapoints</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">probs</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the KernelPrior class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_library : KernelLibrary</span>
<span class="sd">            An instance of the KernelLibrary class, containing</span>
<span class="sd">            the kernel classes and operators, and transformation functions.</span>
<span class="sd">            The TreeStructurePrior and ParameterPrior classes are initialized</span>
<span class="sd">            using the kernel_library.</span>
<span class="sd">        max_depth : int</span>
<span class="sd">            The maximum depth of the nested kernel structure tree.</span>
<span class="sd">        num_datapoints : int</span>
<span class="sd">            The number of data points in the dataset.</span>
<span class="sd">        probs : tp.Optional[ Float[jnp.ndarray, &quot; D&quot;]], optional</span>
<span class="sd">            The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">            The array must have the same length as the the arrays in the kernel library.</span>
<span class="sd">            By default None, which will use a uniform distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span> <span class="o">=</span> <span class="n">kernel_library</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span> <span class="o">=</span> <span class="n">TreeStructurePrior</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="p">,</span>
            <span class="n">probs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span> <span class="o">=</span> <span class="n">num_datapoints</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_prior</span> <span class="o">=</span> <span class="n">ParameterPrior</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_graphdef</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_kernel_parameter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kernel_library</span><span class="o">.</span><span class="n">max_atom_parameters</span> <span class="o">*</span> <span class="n">calculate_max_leaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">support_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">support_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample a kernel structure and its parameters from the prior distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKeyArray</span>
<span class="sd">            Random key for sampling.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nnx.State</span>
<span class="sd">        The state of the sampled kernel, combine with the graphdef</span>
<span class="sd">        to create a TreeKernel object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree_key</span><span class="p">,</span> <span class="n">parameter_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">kernel_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">tree_key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="n">TreeKernel</span><span class="p">(</span>
            <span class="n">kernel_structure</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

        <span class="n">kernel_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">parameter_key</span><span class="p">,</span>
            <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">kernel_state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TreeKernel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample a kernel state using self.sample and merge</span>
<span class="sd">        it with the graphdef and static_state to create a</span>
<span class="sd">        TreeKernel.</span>

<span class="sd">        This function is convenient for sampling a kernel</span>
<span class="sd">        directly, but not vmap or jittable (at least not</span>
<span class="sd">        using the jax commands, potentially using the</span>
<span class="sd">        nnx ones.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKeyArray</span>
<span class="sd">            Random key for sampling.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TreeKernel</span>
<span class="sd">            The sampled kernel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kernel_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nnx</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span><span class="p">,</span> <span class="n">kernel_state</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_kernel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TreeKernel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create new TreeKernel from kernel state using the graphdef,</span>
<span class="sd">        and reset some kernel attributes. In principle,</span>
<span class="sd">        this is unnecessary since the values are already</span>
<span class="sd">        set in the kernel state, but we need to make it</span>
<span class="sd">        explicit for the jit compilation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_state : nnx.State</span>
<span class="sd">            The kernel state to be used to create the kernel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TreeKernel</span>
<span class="sd">            The TreeKernel instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span><span class="p">,</span> <span class="n">kernel_state</span><span class="p">)</span>

        <span class="n">max_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>
        <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
        <span class="n">max_leaves</span> <span class="o">=</span> <span class="n">calculate_max_leaves</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
        <span class="n">max_stack</span> <span class="o">=</span> <span class="n">calculate_max_stack_size</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_depth</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">max_nodes</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_nodes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">max_leaves</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_leaves</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_leaves</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">max_stack</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_stack</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_stack</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">num_atoms</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">num_atoms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">num_datapoints</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">num_datapoints</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kernel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_graphdef</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nnx</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a random kernel and return the graphdef.</span>

<span class="sd">        This function is used to create a graphdef for the</span>
<span class="sd">        kernel (which is set as attribute in the __init__).</span>
<span class="sd">        The graphdef should be the same for all possible</span>
<span class="sd">        kernels, so we can reuse it whenever we need to</span>
<span class="sd">        create a KernelTree object from a kernel state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nnx.GraphDef</span>
<span class="sd">            The graph definition of the kernel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

        <span class="n">kernel_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="n">TreeKernel</span><span class="p">(</span>
            <span class="n">kernel_structure</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">graphdef</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graphdef</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AbstractAtom</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">atoms</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">operators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AbstractOperator</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">operators</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bool</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">is_operator</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">probs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">probs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">max_depth</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prior_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tfb</span><span class="o">.</span><span class="n">Bijector</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">prior_transforms</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.KernelPrior.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">kernel_library</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">num_datapoints</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the KernelPrior class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kernel_library</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="KernelLibrary (gallifrey.kernels.library.KernelLibrary)" href="../library/#gallifrey.kernels.library.KernelLibrary">KernelLibrary</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the KernelLibrary class, containing
the kernel classes and operators, and transformation functions.
The TreeStructurePrior and ParameterPrior classes are initialized
using the kernel_library.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel structure tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_datapoints</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of data points in the dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>probs</code>
            </td>
            <td>
                  <code><span title="beartype.typing.Optional">Optional</span>[<span title="jaxtyping.Float">Float</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probabilities of sampling each kernel (or operator) in the library.
The array must have the same length as the the arrays in the kernel library.
By default None, which will use a uniform distribution.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_datapoints</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">probs</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the KernelPrior class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_library : KernelLibrary</span>
<span class="sd">        An instance of the KernelLibrary class, containing</span>
<span class="sd">        the kernel classes and operators, and transformation functions.</span>
<span class="sd">        The TreeStructurePrior and ParameterPrior classes are initialized</span>
<span class="sd">        using the kernel_library.</span>
<span class="sd">    max_depth : int</span>
<span class="sd">        The maximum depth of the nested kernel structure tree.</span>
<span class="sd">    num_datapoints : int</span>
<span class="sd">        The number of data points in the dataset.</span>
<span class="sd">    probs : tp.Optional[ Float[jnp.ndarray, &quot; D&quot;]], optional</span>
<span class="sd">        The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">        The array must have the same length as the the arrays in the kernel library.</span>
<span class="sd">        By default None, which will use a uniform distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span> <span class="o">=</span> <span class="n">kernel_library</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span> <span class="o">=</span> <span class="n">TreeStructurePrior</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">,</span>
        <span class="n">probs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span> <span class="o">=</span> <span class="n">num_datapoints</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_prior</span> <span class="o">=</span> <span class="n">ParameterPrior</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_graphdef</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">max_kernel_parameter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">kernel_library</span><span class="o">.</span><span class="n">max_atom_parameters</span> <span class="o">*</span> <span class="n">calculate_max_leaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">support_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">support_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.KernelPrior.reconstruct_kernel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reconstruct_kernel</span><span class="p">(</span><span class="n">kernel_state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create new TreeKernel from kernel state using the graphdef,
and reset some kernel attributes. In principle,
this is unnecessary since the values are already
set in the kernel state, but we need to make it
explicit for the jit compilation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kernel_state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The kernel state to be used to create the kernel.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="TreeKernel (gallifrey.kernels.tree.TreeKernel)" href="../tree/#gallifrey.kernels.tree.TreeKernel">TreeKernel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The TreeKernel instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_kernel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TreeKernel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create new TreeKernel from kernel state using the graphdef,</span>
<span class="sd">    and reset some kernel attributes. In principle,</span>
<span class="sd">    this is unnecessary since the values are already</span>
<span class="sd">    set in the kernel state, but we need to make it</span>
<span class="sd">    explicit for the jit compilation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_state : nnx.State</span>
<span class="sd">        The kernel state to be used to create the kernel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TreeKernel</span>
<span class="sd">        The TreeKernel instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span><span class="p">,</span> <span class="n">kernel_state</span><span class="p">)</span>

    <span class="n">max_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>
    <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
    <span class="n">max_leaves</span> <span class="o">=</span> <span class="n">calculate_max_leaves</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
    <span class="n">max_stack</span> <span class="o">=</span> <span class="n">calculate_max_stack_size</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_depth</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">max_nodes</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_nodes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">max_leaves</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_leaves</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_leaves</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">max_stack</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">max_stack</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">max_stack</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">num_atoms</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">num_atoms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)</span>
    <span class="n">kernel</span><span class="o">.</span><span class="n">num_datapoints</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">num_datapoints</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kernel</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.KernelPrior.sample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sample a kernel structure and its parameters from the prior distribution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>The state of the sampled kernel, combine with the graphdef</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>to create a TreeKernel object.</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample a kernel structure and its parameters from the prior distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nnx.State</span>
<span class="sd">    The state of the sampled kernel, combine with the graphdef</span>
<span class="sd">    to create a TreeKernel object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tree_key</span><span class="p">,</span> <span class="n">parameter_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">kernel_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">tree_key</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_structure_prior</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">TreeKernel</span><span class="p">(</span>
        <span class="n">kernel_structure</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_library</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_datapoints</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

    <span class="n">kernel_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">parameter_key</span><span class="p">,</span>
        <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">kernel_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.KernelPrior.sample_kernel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_kernel</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sample a kernel state using self.sample and merge
it with the graphdef and static_state to create a
TreeKernel.</p>
<p>This function is convenient for sampling a kernel
directly, but not vmap or jittable (at least not
using the jax commands, potentially using the
nnx ones.)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="TreeKernel (gallifrey.kernels.tree.TreeKernel)" href="../tree/#gallifrey.kernels.tree.TreeKernel">TreeKernel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sampled kernel.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TreeKernel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample a kernel state using self.sample and merge</span>
<span class="sd">    it with the graphdef and static_state to create a</span>
<span class="sd">    TreeKernel.</span>

<span class="sd">    This function is convenient for sampling a kernel</span>
<span class="sd">    directly, but not vmap or jittable (at least not</span>
<span class="sd">    using the jax commands, potentially using the</span>
<span class="sd">    nnx ones.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TreeKernel</span>
<span class="sd">        The sampled kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kernel_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nnx</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphdef</span><span class="p">,</span> <span class="n">kernel_state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gallifrey.kernels.prior.ParameterPrior" class="doc doc-heading">
            <code>ParameterPrior</code>


</h2>


    <div class="doc doc-contents ">


        <p>This class defines a prior distribution over kernel parameters.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.num_parameter_array">num_parameter_array</span></code></td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that contains the number of parameters for each
atom in the kernel structure. Needs to be in same order
as the atom library.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.max_atom_parameters">max_atom_parameters</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of parameters for an atom in the kernel structure.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.max_leaves">max_leaves</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of leaves in the tree.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.max_nodes">max_nodes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of nodes in the kernel structure.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.support_mapping_array">support_mapping_array</span></code></td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that maps the support of the parameters to the
corresponding bijector index.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.forward_bijectors">forward_bijectors</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="tensorflow_probability.substrates.jax.bijectors.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of bijectors to transform the sampled parameters from
a standard normal to the desired prior distribution.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.ParameterPrior.inverse_bijectors">inverse_bijectors</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="tensorflow_probability.substrates.jax.bijectors.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of bijectors to transform the sampled parameters from
the prior distribution back to a standard normal.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParameterPrior</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class defines a prior distribution over kernel parameters.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_parameter_array : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that contains the number of parameters for each</span>
<span class="sd">        atom in the kernel structure. Needs to be in same order</span>
<span class="sd">        as the atom library.</span>
<span class="sd">    max_atom_parameters : int</span>
<span class="sd">        The maximum number of parameters for an atom in the kernel structure.</span>
<span class="sd">    max_leaves : int</span>
<span class="sd">        The maximum number of leaves in the tree.</span>
<span class="sd">    max_nodes : int</span>
<span class="sd">        The maximum number of nodes in the kernel structure.</span>
<span class="sd">    support_mapping_array : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that maps the support of the parameters to the</span>
<span class="sd">        corresponding bijector index.</span>
<span class="sd">    forward_bijectors : tuple[tfb.Callable]</span>
<span class="sd">        A tuple of bijectors to transform the sampled parameters from</span>
<span class="sd">        a standard normal to the desired prior distribution.</span>
<span class="sd">    inverse_bijectors : tuple[tfb.Callable]</span>
<span class="sd">        A tuple of bijectors to transform the sampled parameters from</span>
<span class="sd">        the prior distribution back to a standard normal.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ParameterPrior class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_library : KernelLibrary</span>
<span class="sd">            An instance of the KernelLibrary class, containing</span>
<span class="sd">            the kernel classes and operators, and transformation functions.</span>
<span class="sd">            The prior_transforms dictionary is used to transform the</span>
<span class="sd">            sampled parameters to the desired prior distribution.</span>
<span class="sd">        max_depth : int</span>
<span class="sd">            The maximum depth of the kernel tree.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">num_parameter</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">library</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">max_atom_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_max_leaves</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_mapping_array</span>

        <span class="c1"># create tuples of callables for forward and inverse bijectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">kernel_library</span><span class="o">.</span><span class="n">prior_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inverse_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">kernel_library</span><span class="o">.</span><span class="n">prior_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">inverse</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="n">ScalarFloat</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample kernel parameter and assign it to the kernel. Also</span>
<span class="sd">        returns the log probability of the sampled parameters.</span>


<span class="sd">        The kernel parameter are sampled from a standard normal and</span>
<span class="sd">        transformed to follow their corresponding prior distributions</span>
<span class="sd">        defined by the parameter_transforms dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKeyArray</span>
<span class="sd">            Random key for sampling.</span>
<span class="sd">        state : nnx.State</span>
<span class="sd">            The original kernel state to be filled with new parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nnx.State</span>
<span class="sd">            The state with the sampled parameters.</span>
<span class="sd">        ScalarFloat</span>
<span class="sd">            The log probability of the sampled parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_subset</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span><span class="p">),</span>  <span class="c1"># all nodes are considered</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_subset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
        <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="n">ScalarFloat</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample kernel parameter and assign it to the kernel.</span>
<span class="sd">        Same as &#39;sample&#39; method but with additional</span>
<span class="sd">        parameter &#39;considered_nodes&#39;, which can be used</span>
<span class="sd">        to only sample parameters for a subset of nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKeyArray</span>
<span class="sd">            Random key for sampling.</span>
<span class="sd">        state : nnx.State</span>
<span class="sd">            The original kernel state to be filled with new parameters.</span>
<span class="sd">        considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">            An array that contains the indices of the nodes that</span>
<span class="sd">            are supposed to be sampled. (Padded with -1 if</span>
<span class="sd">            necessary.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nnx.State</span>
<span class="sd">            The state with the sampled parameters.</span>
<span class="sd">        ScalarFloat</span>
<span class="sd">            The log probability of the sampled parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_state</span><span class="p">,</span> <span class="n">log_prob</span> <span class="o">=</span> <span class="n">sample_parameters</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">considered_nodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_bijectors</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">log_prob</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the log probability of the kernel parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : nnx.State</span>
<span class="sd">            The kernel state with the parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ScalarFloat</span>
<span class="sd">            The log probability of the kernel parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_prob_subset</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span><span class="p">),</span>  <span class="c1"># all nodes are considered</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob_subset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
        <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the log probability of the kernel parameters.</span>
<span class="sd">        Same as &#39;log_prob&#39; method but with additional</span>
<span class="sd">        parameter &#39;considered_nodes&#39;, which can be used</span>
<span class="sd">        to only calculate the log probability for a subset of nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : nnx.State</span>
<span class="sd">            The kernel state with the parameters.</span>
<span class="sd">        considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">            An array that contains the indices of the nodes that</span>
<span class="sd">            are supposed to be sampled. (Padded with -1 if</span>
<span class="sd">            necessary.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ScalarFloat</span>
<span class="sd">            The log probability of the kernel parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">log_prob_parameters</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">considered_nodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inverse_bijectors</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.ParameterPrior.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">kernel_library</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the ParameterPrior class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kernel_library</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="KernelLibrary (gallifrey.kernels.library.KernelLibrary)" href="../library/#gallifrey.kernels.library.KernelLibrary">KernelLibrary</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the KernelLibrary class, containing
the kernel classes and operators, and transformation functions.
The prior_transforms dictionary is used to transform the
sampled parameters to the desired prior distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the kernel tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ParameterPrior class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_library : KernelLibrary</span>
<span class="sd">        An instance of the KernelLibrary class, containing</span>
<span class="sd">        the kernel classes and operators, and transformation functions.</span>
<span class="sd">        The prior_transforms dictionary is used to transform the</span>
<span class="sd">        sampled parameters to the desired prior distribution.</span>
<span class="sd">    max_depth : int</span>
<span class="sd">        The maximum depth of the kernel tree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">num_parameter</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">library</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">max_atom_parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_max_leaves</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_mapping_array</span>

    <span class="c1"># create tuples of callables for forward and inverse bijectors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forward_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">kernel_library</span><span class="o">.</span><span class="n">prior_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">forward</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inverse_bijectors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">kernel_library</span><span class="o">.</span><span class="n">prior_transforms</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">inverse</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">support_tag_mapping</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.ParameterPrior.log_prob" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_prob</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the log probability of the kernel parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The kernel state with the parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the kernel parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the log probability of the kernel parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The kernel state with the parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The log probability of the kernel parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_prob_subset</span><span class="p">(</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span><span class="p">),</span>  <span class="c1"># all nodes are considered</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.ParameterPrior.log_prob_subset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_prob_subset</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">considered_nodes</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the log probability of the kernel parameters.
Same as 'log_prob' method but with additional
parameter 'considered_nodes', which can be used
to only calculate the log probability for a subset of nodes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The kernel state with the parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>considered_nodes</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that contains the indices of the nodes that
are supposed to be sampled. (Padded with -1 if
necessary.)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the kernel parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_prob_subset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the log probability of the kernel parameters.</span>
<span class="sd">    Same as &#39;log_prob&#39; method but with additional</span>
<span class="sd">    parameter &#39;considered_nodes&#39;, which can be used</span>
<span class="sd">    to only calculate the log probability for a subset of nodes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The kernel state with the parameters.</span>
<span class="sd">    considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that contains the indices of the nodes that</span>
<span class="sd">        are supposed to be sampled. (Padded with -1 if</span>
<span class="sd">        necessary.)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The log probability of the kernel parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">log_prob_parameters</span><span class="p">(</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">considered_nodes</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverse_bijectors</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.ParameterPrior.sample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sample kernel parameter and assign it to the kernel. Also
returns the log probability of the sampled parameters.</p>
<p>The kernel parameter are sampled from a standard normal and
transformed to follow their corresponding prior distributions
defined by the parameter_transforms dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original kernel state to be filled with new parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The state with the sampled parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the sampled parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="n">ScalarFloat</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample kernel parameter and assign it to the kernel. Also</span>
<span class="sd">    returns the log probability of the sampled parameters.</span>


<span class="sd">    The kernel parameter are sampled from a standard normal and</span>
<span class="sd">    transformed to follow their corresponding prior distributions</span>
<span class="sd">    defined by the parameter_transforms dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The original kernel state to be filled with new parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nnx.State</span>
<span class="sd">        The state with the sampled parameters.</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The log probability of the sampled parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_subset</span><span class="p">(</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span><span class="p">),</span>  <span class="c1"># all nodes are considered</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.ParameterPrior.sample_subset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_subset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">considered_nodes</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sample kernel parameter and assign it to the kernel.
Same as 'sample' method but with additional
parameter 'considered_nodes', which can be used
to only sample parameters for a subset of nodes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original kernel state to be filled with new parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>considered_nodes</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that contains the indices of the nodes that
are supposed to be sampled. (Padded with -1 if
necessary.)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The state with the sampled parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the sampled parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample_subset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="n">ScalarFloat</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample kernel parameter and assign it to the kernel.</span>
<span class="sd">    Same as &#39;sample&#39; method but with additional</span>
<span class="sd">    parameter &#39;considered_nodes&#39;, which can be used</span>
<span class="sd">    to only sample parameters for a subset of nodes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The original kernel state to be filled with new parameters.</span>
<span class="sd">    considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that contains the indices of the nodes that</span>
<span class="sd">        are supposed to be sampled. (Padded with -1 if</span>
<span class="sd">        necessary.)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nnx.State</span>
<span class="sd">        The state with the sampled parameters.</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The log probability of the sampled parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_state</span><span class="p">,</span> <span class="n">log_prob</span> <span class="o">=</span> <span class="n">sample_parameters</span><span class="p">(</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">considered_nodes</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_parameter_array</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leaves</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_atom_parameters</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_mapping_array</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_bijectors</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">log_prob</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="gallifrey.kernels.prior.TreeStructurePrior" class="doc doc-heading">
            <code>TreeStructurePrior</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="tensorflow_probability.substrates.jax.distributions.Distribution">Distribution</span></code></p>


        <p>A prior distribution over kernel structures.</p>
<p>The TreeStructurePrior is a distribution over kernel structures. The kernel
structure is represented as a tree, where each leaf corresponds to a kernel. The
tree is constructed by sampling from a library of kernel classes and operators.
The operators are used to construct nested kernel structures.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.TreeStructurePrior.library">library</span></code></td>
            <td>
                  <code><span title="beartype.typing.List">List</span>[<span title="beartype.typing.Type">Type</span>[<span title="AbstractKernel">AbstractKernel</span>] | <span title="beartype.typing.Callable">Callable</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of kernel classes and operators, as defined in the KernelLibrary class.
See gallifrey.kernels.library.KernelLibrary for more details.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.TreeStructurePrior.is_operator">is_operator</span></code></td>
            <td>
                  <code><span title="beartype.typing.List">List</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of booleans indicating whether each element in the library is an
operator.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.TreeStructurePrior.max_depth">max_depth</span></code></td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel structure tree.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="gallifrey.kernels.prior.TreeStructurePrior.probs">probs</span></code></td>
            <td>
                  <code><span title="jax.numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probabilities of sampling each kernel (or operator) in the library.
See kernels.library.KernelLibrary and gallifrey.config.GPConfig for more
details.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TreeStructurePrior</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Distribution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A prior distribution over kernel structures.</span>

<span class="sd">    The TreeStructurePrior is a distribution over kernel structures. The kernel</span>
<span class="sd">    structure is represented as a tree, where each leaf corresponds to a kernel. The</span>
<span class="sd">    tree is constructed by sampling from a library of kernel classes and operators.</span>
<span class="sd">    The operators are used to construct nested kernel structures.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    library : tp.List[tp.Type[AbstractKernel] | tp.Callable]</span>
<span class="sd">        A list of kernel classes and operators, as defined in the KernelLibrary class.</span>
<span class="sd">        See gallifrey.kernels.library.KernelLibrary for more details.</span>
<span class="sd">    is_operator : tp.List[bool]</span>
<span class="sd">        A list of booleans indicating whether each element in the library is an</span>
<span class="sd">        operator.</span>
<span class="sd">    max_depth : ScalarInt</span>
<span class="sd">        The maximum depth of the nested kernel structure tree.</span>
<span class="sd">    probs : jnp.ndarray</span>
<span class="sd">        The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">        See kernels.library.KernelLibrary and gallifrey.config.GPConfig for more</span>
<span class="sd">        details.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">probs</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">validate_args</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the KernelPrior distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_library : KernelLibrary</span>
<span class="sd">            An instance of the KernelLibrary class, containing the kernel classes and</span>
<span class="sd">            operators. (See gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">        max_depth : int</span>
<span class="sd">            The maximum depth of the nested kernel structure tree.</span>
<span class="sd">        probs :  Float[jnp.ndarray, &quot; D&quot;], optional</span>
<span class="sd">            The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">            The array must have the same length as the the arrays in the kernel library.</span>
<span class="sd">            By default None, which will use a uniform distribution.</span>
<span class="sd">        validate_args : tp.Optional[bool], optional</span>
<span class="sd">            Whether to validate input, by default None. NOT IMPLEMENTED.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the probs are not one-dimensional.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the probs do not have the same length as the kernel_library</span>
<span class="sd">            along the last dimension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize the kernel functions and the probabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">is_operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span> <span class="k">if</span> <span class="n">probs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;probs&#39; must be one-dimensional.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;probs&#39; must have same length along the last &quot;</span>
                <span class="s2">&quot;dimension as &#39;kernel_library&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got &#39;probs&#39; shape: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;kernel_library&#39; length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct an abstract representation of a kernel structure by sampling from</span>
<span class="sd">        the kernel library.</span>
<span class="sd">        The kernels are sampled from the library according to the defined</span>
<span class="sd">        probabilities.</span>
<span class="sd">        The structure is represented as a one-dimensional array, according to</span>
<span class="sd">        the level-order traversal of the tree. This means:</span>
<span class="sd">        - The root node is at position 0.</span>
<span class="sd">        - The left child of a node at position i is at position 2*i + 1.</span>
<span class="sd">        - The right child of a node at position i is at position 2*i + 2.</span>
<span class="sd">        - Empty nodes are labeled -1.</span>
<span class="sd">        See gallifrey.kernels.tree.TreeKernel for more details and an example.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKeyArray</span>
<span class="sd">            Random key for sampling.</span>
<span class="sd">        max_depth : ScalarInt, optional</span>
<span class="sd">            The maximum depth of the nested kernel structure tree, by default None.</span>
<span class="sd">            If None, the maximum depth is set to the value of self.max_depth.</span>
<span class="sd">        root_idx : ScalarInt, optional</span>
<span class="sd">            The index of the root node in the tree, by default 0. Used</span>
<span class="sd">            for sub-trees.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">            An array that describes the kernel structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>

        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;max_depth&#39; must be 0 or larger.&quot;</span><span class="p">)</span>

        <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>

        <span class="c1"># create sample array to be filled, this will be the output (empty</span>
        <span class="c1"># nodes are labeled -1)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># create initial stack: empty except for the root node</span>
        <span class="n">initial_stack</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">root_idx</span><span class="p">)</span>

        <span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># initial position of the stack pointer</span>

        <span class="n">initial_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">initial_stack</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_sample_single</span><span class="p">(</span>
            <span class="n">initial_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
        <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">path_to_hole</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hole_idx</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the log probability of a given kernel structure,</span>
<span class="sd">        as represented by the level-order tree array.</span>
<span class="sd">        The maximum depth of the tree is inferred from the length of the array.</span>

<span class="sd">        The function can also be used to calculate the log probability of a</span>
<span class="sd">        scaffold structure (used by the detach-attach move), by providing</span>
<span class="sd">        the path to the hole and the hole index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value :  Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">            An array that describes the kernel structure.</span>
<span class="sd">        root_idx : ScalarInt, optional</span>
<span class="sd">            The index of the root node in the tree, by default 0.</span>
<span class="sd">        path_to_hole :  Int[jnp.ndarray, &quot; D&quot;], optional</span>
<span class="sd">            The path to the hole in the tree. A list of indices that</span>
<span class="sd">            describe the path from the root to the hole (level order</span>
<span class="sd">            indices), by default None (sets it to an empty array).</span>
<span class="sd">        hole_idx : ScalarInt, optional</span>
<span class="sd">            The index of the hole in the tree (level order index),</span>
<span class="sd">            by default None(sets it to -1 which should never be</span>
<span class="sd">            reached).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ScalarFloat</span>
<span class="sd">            The log probability of the given kernel structure or scaffold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="n">calculate_max_depth</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">)</span>

        <span class="n">initial_log_p</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">inital_stack</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">root_idx</span><span class="p">)</span>
        <span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_log_p</span><span class="p">,</span> <span class="n">inital_stack</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>

        <span class="c1"># set the path to the hole and the hole index, if not given</span>
        <span class="n">path_to_hole</span> <span class="o">=</span> <span class="n">path_to_hole</span> <span class="k">if</span> <span class="n">path_to_hole</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">hole_idx</span> <span class="o">=</span> <span class="n">hole_idx</span> <span class="k">if</span> <span class="n">hole_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">_log_prob_single</span><span class="p">(</span>
            <span class="n">initial_state</span><span class="p">,</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="p">,</span>
            <span class="n">path_to_hole</span><span class="p">,</span>
            <span class="n">hole_idx</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">sample_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample kernel structures. For details, see `sample_single`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : PRNGKey</span>
<span class="sd">            Random key for sampling.</span>
<span class="sd">        max_depth : ScalarInt</span>
<span class="sd">            The maximum depth of the nested kernel tree structure. If None,</span>
<span class="sd">            the maximum depth is set to the value of self.max_depth.</span>
<span class="sd">        root_idx : ScalarInt, optional</span>
<span class="sd">            The index of the root node in the tree, by default 0.</span>
<span class="sd">            Used for sub-trees.</span>
<span class="sd">        sample_shape : tuple, optional</span>
<span class="sd">            The sample shape for the distribution, by default ().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Int[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">            An array of samples describing kernel structures,</span>
<span class="sd">            of shape sample_shape + (max_nodes,).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_single</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">root_idx</span><span class="p">)</span>

        <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>

        <span class="c1"># flatten the sample_shape for vectorized sampling</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span><span class="p">))</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_single</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span>
            <span class="n">keys</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="p">,</span>
            <span class="n">root_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sample_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_nodes</span><span class="p">,))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">],</span>
        <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">path_to_hole</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hole_idx</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the log probability of given kernel structures or scaffolds.</span>
<span class="sd">        (See log_prob_single for details.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value :  Int[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">            Expression of kernel structure(s).</span>
<span class="sd">        root_idx : ScalarInt, optional</span>
<span class="sd">            The index of the root node in the tree, by default 0.</span>
<span class="sd">        path_to_hole :  Int[jnp.ndarray, &quot;...&quot;], optional</span>
<span class="sd">            Optional path to the hole in the tree, if calculating the log</span>
<span class="sd">            probability of a scaffold, by default None.</span>
<span class="sd">        hole_idx : ScalarInt, optional</span>
<span class="sd">            The index of the hole in the tree if calculating the log</span>
<span class="sd">            probability of a scaffold, by default None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">         Float[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">            The log probability of the given kernel structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_shape</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>
        <span class="n">log_probs</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_prob_single</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span>
            <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">root_idx</span><span class="p">,</span>
            <span class="n">path_to_hole</span><span class="p">,</span>
            <span class="n">hole_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">log_probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.TreeStructurePrior.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">kernel_library</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the KernelPrior distribution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kernel_library</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="KernelLibrary (gallifrey.kernels.library.KernelLibrary)" href="../library/#gallifrey.kernels.library.KernelLibrary">KernelLibrary</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the KernelLibrary class, containing the kernel classes and
operators. (See gallifrey.kernels.library.KernelLibrary)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel structure tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>probs</code>
            </td>
            <td>
                  <code> Float[jnp.ndarray, &#34; D&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The probabilities of sampling each kernel (or operator) in the library.
The array must have the same length as the the arrays in the kernel library.
By default None, which will use a uniform distribution.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validate_args</code>
            </td>
            <td>
                  <code><span title="beartype.typing.Optional">Optional</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to validate input, by default None. NOT IMPLEMENTED.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the probs are not one-dimensional.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the probs do not have the same length as the kernel_library
along the last dimension.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel_library</span><span class="p">:</span> <span class="n">KernelLibrary</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">probs</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">validate_args</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the KernelPrior distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kernel_library : KernelLibrary</span>
<span class="sd">        An instance of the KernelLibrary class, containing the kernel classes and</span>
<span class="sd">        operators. (See gallifrey.kernels.library.KernelLibrary)</span>
<span class="sd">    max_depth : int</span>
<span class="sd">        The maximum depth of the nested kernel structure tree.</span>
<span class="sd">    probs :  Float[jnp.ndarray, &quot; D&quot;], optional</span>
<span class="sd">        The probabilities of sampling each kernel (or operator) in the library.</span>
<span class="sd">        The array must have the same length as the the arrays in the kernel library.</span>
<span class="sd">        By default None, which will use a uniform distribution.</span>
<span class="sd">    validate_args : tp.Optional[bool], optional</span>
<span class="sd">        Whether to validate input, by default None. NOT IMPLEMENTED.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the probs are not one-dimensional.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the probs do not have the same length as the kernel_library</span>
<span class="sd">        along the last dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize the kernel functions and the probabilities</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">library</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">library</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span> <span class="o">=</span> <span class="n">kernel_library</span><span class="o">.</span><span class="n">is_operator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span> <span class="k">if</span> <span class="n">probs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;probs&#39; must be one-dimensional.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;&#39;probs&#39; must have same length along the last &quot;</span>
            <span class="s2">&quot;dimension as &#39;kernel_library&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Got &#39;probs&#39; shape: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;kernel_library&#39; length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.TreeStructurePrior.log_prob" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_prob</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">root_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_to_hole</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hole_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the log probability of given kernel structures or scaffolds.
(See log_prob_single for details.)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code> Int[jnp.ndarray, &#34;...&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Expression of kernel structure(s).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the root node in the tree, by default 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path_to_hole</code>
            </td>
            <td>
                  <code> Int[jnp.ndarray, &#34;...&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to the hole in the tree, if calculating the log
probability of a scaffold, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hole_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the hole in the tree if calculating the log
probability of a scaffold, by default None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code> Float[jnp.ndarray, &#34;...&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the given kernel structures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_prob</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">],</span>
    <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">path_to_hole</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hole_idx</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the log probability of given kernel structures or scaffolds.</span>
<span class="sd">    (See log_prob_single for details.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value :  Int[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">        Expression of kernel structure(s).</span>
<span class="sd">    root_idx : ScalarInt, optional</span>
<span class="sd">        The index of the root node in the tree, by default 0.</span>
<span class="sd">    path_to_hole :  Int[jnp.ndarray, &quot;...&quot;], optional</span>
<span class="sd">        Optional path to the hole in the tree, if calculating the log</span>
<span class="sd">        probability of a scaffold, by default None.</span>
<span class="sd">    hole_idx : ScalarInt, optional</span>
<span class="sd">        The index of the hole in the tree if calculating the log</span>
<span class="sd">        probability of a scaffold, by default None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     Float[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">        The log probability of the given kernel structures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_shape</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">num_samples</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>
    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_prob_single</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span>
        <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">root_idx</span><span class="p">,</span>
        <span class="n">path_to_hole</span><span class="p">,</span>
        <span class="n">hole_idx</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">log_probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.TreeStructurePrior.log_prob_single" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_prob_single</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">root_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_to_hole</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hole_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the log probability of a given kernel structure,
as represented by the level-order tree array.
The maximum depth of the tree is inferred from the length of the array.</p>
<p>The function can also be used to calculate the log probability of a
scaffold structure (used by the detach-attach move), by providing
the path to the hole and the hole index.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code> Int[jnp.ndarray, &#34; D&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that describes the kernel structure.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the root node in the tree, by default 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path_to_hole</code>
            </td>
            <td>
                  <code> Int[jnp.ndarray, &#34; D&#34;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the hole in the tree. A list of indices that
describe the path from the root to the hole (level order
indices), by default None (sets it to an empty array).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hole_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the hole in the tree (level order index),
by default None(sets it to -1 which should never be
reached).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log probability of the given kernel structure or scaffold.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_prob_single</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">path_to_hole</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hole_idx</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the log probability of a given kernel structure,</span>
<span class="sd">    as represented by the level-order tree array.</span>
<span class="sd">    The maximum depth of the tree is inferred from the length of the array.</span>

<span class="sd">    The function can also be used to calculate the log probability of a</span>
<span class="sd">    scaffold structure (used by the detach-attach move), by providing</span>
<span class="sd">    the path to the hole and the hole index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value :  Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that describes the kernel structure.</span>
<span class="sd">    root_idx : ScalarInt, optional</span>
<span class="sd">        The index of the root node in the tree, by default 0.</span>
<span class="sd">    path_to_hole :  Int[jnp.ndarray, &quot; D&quot;], optional</span>
<span class="sd">        The path to the hole in the tree. A list of indices that</span>
<span class="sd">        describe the path from the root to the hole (level order</span>
<span class="sd">        indices), by default None (sets it to an empty array).</span>
<span class="sd">    hole_idx : ScalarInt, optional</span>
<span class="sd">        The index of the hole in the tree (level order index),</span>
<span class="sd">        by default None(sets it to -1 which should never be</span>
<span class="sd">        reached).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The log probability of the given kernel structure or scaffold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="n">calculate_max_depth</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">)</span>

    <span class="n">initial_log_p</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">inital_stack</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">root_idx</span><span class="p">)</span>
    <span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_log_p</span><span class="p">,</span> <span class="n">inital_stack</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>

    <span class="c1"># set the path to the hole and the hole index, if not given</span>
    <span class="n">path_to_hole</span> <span class="o">=</span> <span class="n">path_to_hole</span> <span class="k">if</span> <span class="n">path_to_hole</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">hole_idx</span> <span class="o">=</span> <span class="n">hole_idx</span> <span class="k">if</span> <span class="n">hole_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">_log_prob_single</span><span class="p">(</span>
        <span class="n">initial_state</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">,</span>
        <span class="n">path_to_hole</span><span class="p">,</span>
        <span class="n">hole_idx</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.TreeStructurePrior.sample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">())</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sample kernel structures. For details, see <code>sample_single</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="PRNGKey">PRNGKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel tree structure. If None,
the maximum depth is set to the value of self.max_depth.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the root node in the tree, by default 0.
Used for sub-trees.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sample shape for the distribution, by default ().</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of samples describing kernel structures,
of shape sample_shape + (max_nodes,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sample_shape</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample kernel structures. For details, see `sample_single`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKey</span>
<span class="sd">        Random key for sampling.</span>
<span class="sd">    max_depth : ScalarInt</span>
<span class="sd">        The maximum depth of the nested kernel tree structure. If None,</span>
<span class="sd">        the maximum depth is set to the value of self.max_depth.</span>
<span class="sd">    root_idx : ScalarInt, optional</span>
<span class="sd">        The index of the root node in the tree, by default 0.</span>
<span class="sd">        Used for sub-trees.</span>
<span class="sd">    sample_shape : tuple, optional</span>
<span class="sd">        The sample shape for the distribution, by default ().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Int[jnp.ndarray, &quot;...&quot;]</span>
<span class="sd">        An array of samples describing kernel structures,</span>
<span class="sd">        of shape sample_shape + (max_nodes,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_shape</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_single</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">root_idx</span><span class="p">)</span>

    <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>

    <span class="c1"># flatten the sample_shape for vectorized sampling</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span><span class="p">))</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_single</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span>
        <span class="n">keys</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">,</span>
        <span class="n">root_idx</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sample_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_nodes</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="gallifrey.kernels.prior.TreeStructurePrior.sample_single" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_single</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct an abstract representation of a kernel structure by sampling from
the kernel library.
The kernels are sampled from the library according to the defined
probabilities.
The structure is represented as a one-dimensional array, according to
the level-order traversal of the tree. This means:
- The root node is at position 0.
- The left child of a node at position i is at position 2<em>i + 1.
- The right child of a node at position i is at position 2</em>i + 2.
- Empty nodes are labeled -1.
See gallifrey.kernels.tree.TreeKernel for more details and an example.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of the nested kernel structure tree, by default None.
If None, the maximum depth is set to the value of self.max_depth.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_idx</code>
            </td>
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarInt">ScalarInt</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the root node in the tree, by default 0. Used
for sub-trees.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that describes the kernel structure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample_single</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ScalarInt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">root_idx</span><span class="p">:</span> <span class="n">ScalarInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct an abstract representation of a kernel structure by sampling from</span>
<span class="sd">    the kernel library.</span>
<span class="sd">    The kernels are sampled from the library according to the defined</span>
<span class="sd">    probabilities.</span>
<span class="sd">    The structure is represented as a one-dimensional array, according to</span>
<span class="sd">    the level-order traversal of the tree. This means:</span>
<span class="sd">    - The root node is at position 0.</span>
<span class="sd">    - The left child of a node at position i is at position 2*i + 1.</span>
<span class="sd">    - The right child of a node at position i is at position 2*i + 2.</span>
<span class="sd">    - Empty nodes are labeled -1.</span>
<span class="sd">    See gallifrey.kernels.tree.TreeKernel for more details and an example.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>
<span class="sd">    max_depth : ScalarInt, optional</span>
<span class="sd">        The maximum depth of the nested kernel structure tree, by default None.</span>
<span class="sd">        If None, the maximum depth is set to the value of self.max_depth.</span>
<span class="sd">    root_idx : ScalarInt, optional</span>
<span class="sd">        The index of the root node in the tree, by default 0. Used</span>
<span class="sd">        for sub-trees.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that describes the kernel structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span>

    <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;max_depth&#39; must be 0 or larger.&quot;</span><span class="p">)</span>

    <span class="n">max_nodes</span> <span class="o">=</span> <span class="n">calculate_max_nodes</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span>

    <span class="c1"># create sample array to be filled, this will be the output (empty</span>
    <span class="c1"># nodes are labeled -1)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_nodes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># create initial stack: empty except for the root node</span>
    <span class="n">initial_stack</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">root_idx</span><span class="p">)</span>

    <span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># initial position of the stack pointer</span>

    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">initial_stack</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_sample_single</span><span class="p">(</span>
        <span class="n">initial_state</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_operator</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="gallifrey.kernels.prior.log_prob_parameters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">log_prob_parameters</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">considered_nodes</span><span class="p">,</span> <span class="n">num_parameter_array</span><span class="p">,</span> <span class="n">max_leaves</span><span class="p">,</span> <span class="n">max_atom_parameters</span><span class="p">,</span> <span class="n">support_mapping_array</span><span class="p">,</span> <span class="n">inverse_bijectors</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>A function takes a state and calculates the log probability of the
kernel parameters.</p>
<p>It is assumed the parameters are sampled from a standard normal and
then transformed to the desired prior distribution using the
support_mapping_array and the forward_bijectors. In this function,
we transform the parameters back to the standard normal and
calculate the log probability.</p>
<p>We include an input 'considered_nodes' to only sample a specific
subset of nodes. This is useful for structure moves, where only
a subset of the parameters are changed. (Since arrays need to
be of fixed shape, consider_nodes can be padded with -1 or
any value that's not a valid leaf index.)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original kernel state to be filled with new parameters.
The state must contain the following attributes:
- tree_expression: The tree expression that describes the kernel structure.
- leaf_level_map: A array that maps the index of the leaf parameter array</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>considered_nodes</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>This array needs to contain all the indices that are
supposed to be sampled. For first time sampling, that
should be all indices (or at least all leaves). For
structure moves (e.g. subtree-replace move), it should
contain the indices that have been changed from the
previous tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_parameter_array</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that contains the number of parameters for each
atom in the kernel structure. Needs to be in same order
as the atom library.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_leaves</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of leaves in the tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_atom_parameters</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of parameters any atom will take.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>support_mapping_array</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39;M N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that maps the support of the parameters to the
corresponding bijector index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inverse_bijectors</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="beartype.typing.Callable">Callable</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of bijectors to transform the parameters back to
a standard normal.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The (total) log probability of the parameters, sum
of all individual log probabilities.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@partial</span><span class="p">(</span>
    <span class="n">jit</span><span class="p">,</span>
    <span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;max_leaves&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_atom_parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inverse_bijectors&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_prob_parameters</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="n">num_parameter_array</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="n">max_leaves</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_atom_parameters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">support_mapping_array</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span>
    <span class="n">inverse_bijectors</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function takes a state and calculates the log probability of the</span>
<span class="sd">    kernel parameters.</span>

<span class="sd">    It is assumed the parameters are sampled from a standard normal and</span>
<span class="sd">    then transformed to the desired prior distribution using the</span>
<span class="sd">    support_mapping_array and the forward_bijectors. In this function,</span>
<span class="sd">    we transform the parameters back to the standard normal and</span>
<span class="sd">    calculate the log probability.</span>

<span class="sd">    We include an input &#39;considered_nodes&#39; to only sample a specific</span>
<span class="sd">    subset of nodes. This is useful for structure moves, where only</span>
<span class="sd">    a subset of the parameters are changed. (Since arrays need to</span>
<span class="sd">    be of fixed shape, consider_nodes can be padded with -1 or</span>
<span class="sd">    any value that&#39;s not a valid leaf index.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The original kernel state to be filled with new parameters.</span>
<span class="sd">        The state must contain the following attributes:</span>
<span class="sd">        - tree_expression: The tree expression that describes the kernel structure.</span>
<span class="sd">        - leaf_level_map: A array that maps the index of the leaf parameter array</span>
<span class="sd">    considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        This array needs to contain all the indices that are</span>
<span class="sd">        supposed to be sampled. For first time sampling, that</span>
<span class="sd">        should be all indices (or at least all leaves). For</span>
<span class="sd">        structure moves (e.g. subtree-replace move), it should</span>
<span class="sd">        contain the indices that have been changed from the</span>
<span class="sd">        previous tree.</span>
<span class="sd">    num_parameter_array : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that contains the number of parameters for each</span>
<span class="sd">        atom in the kernel structure. Needs to be in same order</span>
<span class="sd">        as the atom library.</span>
<span class="sd">    max_leaves : int</span>
<span class="sd">        The maximum number of leaves in the tree.</span>
<span class="sd">    max_atom_parameters : int</span>
<span class="sd">        The maximum number of parameters any atom will take.</span>
<span class="sd">    support_mapping_array : Int[jnp.ndarray, &quot;M N&quot;]</span>
<span class="sd">        An array that maps the support of the parameters to the</span>
<span class="sd">        corresponding bijector index.</span>
<span class="sd">    inverse_bijectors : tuple[tp.Callable, ...]</span>
<span class="sd">        A tuple of bijectors to transform the parameters back to</span>
<span class="sd">        a standard normal.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The (total) log probability of the parameters, sum</span>
<span class="sd">        of all individual log probabilities.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tree_expression</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tree_expression</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>
    <span class="n">leaf_level_map</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">leaf_level_map</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_params</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]],</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]],</span>
        <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process parameter based on if it&#39;s active and considered.&quot;&quot;&quot;</span>

        <span class="c1"># unpack state and indices</span>
        <span class="n">kernel_parameters</span><span class="p">,</span> <span class="n">log_probability</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span> <span class="o">=</span> <span class="n">indices</span>

        <span class="c1"># check whether the parameter is active</span>
        <span class="n">node_value</span> <span class="o">=</span> <span class="n">tree_expression</span><span class="p">[</span><span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">]]</span>
        <span class="n">atom_num_parameters</span> <span class="o">=</span> <span class="n">num_parameter_array</span><span class="p">[</span><span class="n">node_value</span><span class="p">]</span>

        <span class="n">is_active_node</span> <span class="o">=</span> <span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">is_active_param</span> <span class="o">=</span> <span class="n">parameter_idx</span> <span class="o">&lt;</span> <span class="n">atom_num_parameters</span>
        <span class="n">is_active</span> <span class="o">=</span> <span class="n">is_active_node</span> <span class="o">&amp;</span> <span class="n">is_active_param</span>

        <span class="c1"># check whether the parameter node is part of the considered nodes</span>
        <span class="n">considered_for_sampling</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
            <span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">],</span>
            <span class="n">considered_nodes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_active_and_considered</span><span class="p">(</span><span class="n">indices</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;If active and considered for sampling, transform parameter back</span>
<span class="sd">            to standard normal and calculate probability.&quot;&quot;&quot;</span>
            <span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span> <span class="o">=</span> <span class="n">indices</span>

            <span class="c1"># select parameter and transform back to standard normal</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">kernel_parameters</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">]</span>

            <span class="n">transformed_param</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span>
                <span class="n">support_mapping_array</span><span class="p">[</span><span class="n">node_value</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">],</span>
                <span class="n">inverse_bijectors</span><span class="p">,</span>
                <span class="n">param</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># calculate log probability (standard normal)</span>
            <span class="n">log_prob_param</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">transformed_param</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">log_prob_param</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_others</span><span class="p">(</span><span class="n">indices</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarFloat</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;If not active or not considered for sampling, don&#39;t</span>
<span class="sd">            consider for log probability.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># process parameter, get probabilities</span>
        <span class="n">log_prob_param</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">is_active</span> <span class="o">&amp;</span> <span class="n">considered_for_sampling</span><span class="p">,</span>
            <span class="n">process_active_and_considered</span><span class="p">,</span>
            <span class="n">process_others</span><span class="p">,</span>
            <span class="p">(</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># update the log probability</span>
        <span class="n">log_probability</span> <span class="o">+=</span> <span class="n">log_prob_param</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">kernel_parameters</span><span class="p">,</span> <span class="n">log_probability</span><span class="p">),</span> <span class="n">indices</span>

    <span class="c1"># get initial kernel parameters</span>
    <span class="n">kernel_parameters</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># get all parameter index combinations</span>
    <span class="n">parameter_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">max_leaves</span><span class="p">,</span> <span class="n">max_atom_parameters</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># scan over all parameters and get probabilities</span>
    <span class="n">parameters_and_total_log_prob</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">process_params</span><span class="p">,</span>
        <span class="p">(</span><span class="n">kernel_parameters</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">parameter_indices</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">parameters_and_total_log_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="gallifrey.kernels.prior.sample_parameters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">considered_nodes</span><span class="p">,</span> <span class="n">num_parameter_array</span><span class="p">,</span> <span class="n">max_leaves</span><span class="p">,</span> <span class="n">max_atom_parameters</span><span class="p">,</span> <span class="n">support_mapping_array</span><span class="p">,</span> <span class="n">forward_bijectors</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>A function to sample new parameters for a state, and apply them to
the kernel. Also returns the log probability of the sampled parameters.</p>
<p>The parameters are sampled from a standard normal. Whether a
parameter is sampled or not is determined by the tree expression
and the leaf level map (See 'gallifrey.kernels.tree' for more
information).
The parameter are transformed to the desired prior distribution
using the support_mapping_array and the forward_bijectors.</p>
<p>We include an input 'considered_nodes' to only sample a specific
subset of nodes. This is useful for structure moves, where only
a subset of the parameters are changed. (Since arrays need to
be of fixed shape, consider_nodes can be padded with -1 or
any value that's not a valid leaf index.)</p>
<p>Inactive parameters are set to -1.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="jaxtyping.PRNGKeyArray">PRNGKeyArray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random key for sampling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original kernel state to be filled with new parameters.
The state must contain the following attributes:
- tree_expression: The tree expression that describes the kernel structure.
- leaf_level_map: A array that maps the index of the leaf parameter array</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>considered_nodes</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>This array needs to contain all the indices that are
supposed to be sampled. For first time sampling, that
should be all indices (or at least all leaves). For
structure moves (e.g. subtree-replace move), it should
contain the indices that have been changed from the
previous tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_parameter_array</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39; D&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that contains the number of parameters for each
atom in the kernel structure. Needs to be in same order
as the atom library.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_leaves</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of leaves in the tree.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_atom_parameters</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of parameters any atom will take.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>support_mapping_array</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int">Int</span>[<span title="jax.numpy.ndarray">ndarray</span>, &#39;M N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array that maps the support of the parameters to the
corresponding bijector index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>forward_bijectors</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="beartype.typing.Callable">Callable</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of bijectors to transform the sampled parameters from
a standard normal to the desired prior distribution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="flax.nnx.State">State</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The state with the sampled parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gallifrey.utils.typing.ScalarFloat">ScalarFloat</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The (total) log probability of the sampled parameters, sum
of all individual log probabilities.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>gallifrey/kernels/prior.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@partial</span><span class="p">(</span>
    <span class="n">jit</span><span class="p">,</span>
    <span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;max_leaves&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_atom_parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;forward_bijectors&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sample_parameters</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span>
    <span class="n">considered_nodes</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="n">num_parameter_array</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot; D&quot;</span><span class="p">],</span>
    <span class="n">max_leaves</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_atom_parameters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">support_mapping_array</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span>
    <span class="n">forward_bijectors</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nnx</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="n">ScalarFloat</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to sample new parameters for a state, and apply them to</span>
<span class="sd">    the kernel. Also returns the log probability of the sampled parameters.</span>

<span class="sd">    The parameters are sampled from a standard normal. Whether a</span>
<span class="sd">    parameter is sampled or not is determined by the tree expression</span>
<span class="sd">    and the leaf level map (See &#39;gallifrey.kernels.tree&#39; for more</span>
<span class="sd">    information).</span>
<span class="sd">    The parameter are transformed to the desired prior distribution</span>
<span class="sd">    using the support_mapping_array and the forward_bijectors.</span>

<span class="sd">    We include an input &#39;considered_nodes&#39; to only sample a specific</span>
<span class="sd">    subset of nodes. This is useful for structure moves, where only</span>
<span class="sd">    a subset of the parameters are changed. (Since arrays need to</span>
<span class="sd">    be of fixed shape, consider_nodes can be padded with -1 or</span>
<span class="sd">    any value that&#39;s not a valid leaf index.)</span>

<span class="sd">    Inactive parameters are set to -1.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : PRNGKeyArray</span>
<span class="sd">        Random key for sampling.</span>
<span class="sd">    state : nnx.State</span>
<span class="sd">        The original kernel state to be filled with new parameters.</span>
<span class="sd">        The state must contain the following attributes:</span>
<span class="sd">        - tree_expression: The tree expression that describes the kernel structure.</span>
<span class="sd">        - leaf_level_map: A array that maps the index of the leaf parameter array</span>
<span class="sd">    considered_nodes : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        This array needs to contain all the indices that are</span>
<span class="sd">        supposed to be sampled. For first time sampling, that</span>
<span class="sd">        should be all indices (or at least all leaves). For</span>
<span class="sd">        structure moves (e.g. subtree-replace move), it should</span>
<span class="sd">        contain the indices that have been changed from the</span>
<span class="sd">        previous tree.</span>
<span class="sd">    num_parameter_array : Int[jnp.ndarray, &quot; D&quot;]</span>
<span class="sd">        An array that contains the number of parameters for each</span>
<span class="sd">        atom in the kernel structure. Needs to be in same order</span>
<span class="sd">        as the atom library.</span>
<span class="sd">    max_leaves : int</span>
<span class="sd">        The maximum number of leaves in the tree.</span>
<span class="sd">    max_atom_parameters : int</span>
<span class="sd">        The maximum number of parameters any atom will take.</span>
<span class="sd">    support_mapping_array : Int[jnp.ndarray, &quot;M N&quot;]</span>
<span class="sd">        An array that maps the support of the parameters to the</span>
<span class="sd">        corresponding bijector index.</span>
<span class="sd">    forward_bijectors : tuple[tp.Callable, ...]</span>
<span class="sd">        A tuple of bijectors to transform the sampled parameters from</span>
<span class="sd">        a standard normal to the desired prior distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nnx.State</span>
<span class="sd">        The state with the sampled parameters.</span>
<span class="sd">    ScalarFloat</span>
<span class="sd">        The (total) log probability of the sampled parameters, sum</span>
<span class="sd">        of all individual log probabilities.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tree_expression</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tree_expression</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>
    <span class="n">leaf_level_map</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">leaf_level_map</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_params</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">PRNGKeyArray</span><span class="p">],</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;M N&quot;</span><span class="p">],</span> <span class="n">Float</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">PRNGKeyArray</span><span class="p">],</span>
        <span class="n">Int</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process parameter based on if it&#39;s active and considered for sampling.&quot;&quot;&quot;</span>

        <span class="c1"># unpack state and indices</span>
        <span class="n">kernel_parameter</span><span class="p">,</span> <span class="n">log_probability</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span> <span class="o">=</span> <span class="n">indices</span>

        <span class="c1"># check whether the parameter is active</span>
        <span class="n">node_value</span> <span class="o">=</span> <span class="n">tree_expression</span><span class="p">[</span><span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">]]</span>
        <span class="n">atom_num_parameters</span> <span class="o">=</span> <span class="n">num_parameter_array</span><span class="p">[</span><span class="n">node_value</span><span class="p">]</span>

        <span class="n">is_active_node</span> <span class="o">=</span> <span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">is_active_param</span> <span class="o">=</span> <span class="n">parameter_idx</span> <span class="o">&lt;</span> <span class="n">atom_num_parameters</span>
        <span class="n">is_active</span> <span class="o">=</span> <span class="n">is_active_node</span> <span class="o">&amp;</span> <span class="n">is_active_param</span>

        <span class="c1"># check whether the parameter node is part of the considered nodes</span>
        <span class="n">considered_for_sampling</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
            <span class="n">leaf_level_map</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">],</span>
            <span class="n">considered_nodes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_active_and_considered</span><span class="p">(</span><span class="n">indices_and_key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;If active and considered for sampling, sample and transform the</span>
<span class="sd">            parameter, and calculate the log probability.&quot;&quot;&quot;</span>
            <span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">indices_and_key</span>

            <span class="c1"># sample parameter</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">sampled_param</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">)</span>

            <span class="c1"># calculate log probability (standard normal)</span>
            <span class="n">log_prob_param</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sampled_param</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

            <span class="c1"># transform parameter to desired prior distribution</span>
            <span class="n">transformed_param</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span>
                <span class="n">support_mapping_array</span><span class="p">[</span><span class="n">node_value</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">],</span>
                <span class="n">forward_bijectors</span><span class="p">,</span>
                <span class="n">sampled_param</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">transformed_param</span><span class="p">,</span> <span class="n">log_prob_param</span><span class="p">,</span> <span class="n">key</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_active_not_considered</span><span class="p">(</span><span class="n">indices_and_key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;If active but not considered, return the current parameter.&quot;&quot;&quot;</span>
            <span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">indices_and_key</span>
            <span class="k">return</span> <span class="n">kernel_parameter</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">key</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_inactive</span><span class="p">(</span><span class="n">indices_and_key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;If inactive, return -1.&quot;&quot;&quot;</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">indices_and_key</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">key</span>  <span class="c1"># inactive parameters are set to -1</span>

        <span class="c1"># process parameter, get new parameter and key</span>
        <span class="n">sampled_param</span><span class="p">,</span> <span class="n">log_prob_param</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">is_active</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">considered_for_sampling</span><span class="p">,</span>
                <span class="n">process_active_and_considered</span><span class="p">,</span>
                <span class="n">process_active_not_considered</span><span class="p">,</span>
                <span class="p">(</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">process_inactive</span><span class="p">,</span>
            <span class="p">(</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># update kernel parameter</span>
        <span class="n">kernel_parameter</span> <span class="o">=</span> <span class="n">kernel_parameter</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">leaf_idx</span><span class="p">,</span> <span class="n">parameter_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">sampled_param</span>
        <span class="p">)</span>

        <span class="c1"># update the log probability</span>
        <span class="n">log_probability</span> <span class="o">=</span> <span class="n">log_probability</span> <span class="o">+</span> <span class="n">log_prob_param</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">kernel_parameter</span><span class="p">,</span> <span class="n">log_probability</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">indices</span>

    <span class="c1"># get initial kernel parameters</span>
    <span class="n">kernel_parameters</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># get all parameter index combinations</span>
    <span class="n">parameter_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="n">max_leaves</span><span class="p">,</span> <span class="n">max_atom_parameters</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># scan over all parameters and update kernel parameters</span>
    <span class="n">final_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">process_params</span><span class="p">,</span>
        <span class="p">(</span><span class="n">kernel_parameters</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">key</span><span class="p">),</span>
        <span class="n">parameter_indices</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">new_kernel_parameters</span> <span class="o">=</span> <span class="n">final_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tot_log_prob</span> <span class="o">=</span> <span class="n">final_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="n">new_kernel_parameters</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">tot_log_prob</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy", "content.code.annotate", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>